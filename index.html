<div class="chapter" id="book4-chapter1" style="display: none;">
    <h2>Chapter 1: Web Wizards ‚Äì Code the Clean Spell!</h2>
    
    <div class="story-text">
        <p>The workshop whooshed into a glowy code cave, full of bouncy blocks and starry screens! Twirly Logic Fairy ARIA spun in on a pixel tornado, her wings flashing rainbow if-thens.</p>
        
        <div class="character-speech">
            <strong>Twirly Logic Fairy ARIA:</strong> "Twirl-a-whirl! Codes are giggle-spells for fixing the universe. Deductive? 'If smoky dragon puff, THEN zap with green goo-gone!' Zoom‚Äîproblem poofed! Inductive? 'Feather crumb, feather crumb... ooh, pattern wiggle! Predict the next feather flop!' Spotty-sparky fun!"
        </div>
        
        <p>Little X clapped. "Like Book 3's web zaps, but with blocky magic?"</p>
        
        <div class="character-speech">
            <strong>Boomy Block Basher Raaarrr:</strong> "Raaarrr-boom! I'll bash blocks... oopsie-crash! Hee-hee, that's why we test‚Äîcodes wiggle wrong sometimes, but fix 'em with hero hearts! Dragons code smoky cheats for their gold giggles, but we code clean rivers for fishy tickles. No grumpy smashes‚Äîjust wiggly wins for the whole web crew!"
        </div>
        
        <div class="character-speech">
            <strong>Hooty Hacker Socrates:</strong> "Hooty-hint! Reason's the real wizard wand‚Äîflexy like a vine, not stiff like a grumpy stick. Code to outwit the puffs: Heavy yuck in air? Filter it fair! Water goo? Swirl it pure! Governments sometimes nap on dragon watch, but you code the wake-up sparkle. Play‚Äî and learn why 'why' beats 'what-if' every time!"
        </div>
        
        <p>Raaarrr bashed a block (gently), and sparkles flew. "Ready to spell-cast? Drag blocks to the web, run the code, and watch the magic mend!"</p>
    </div>
    
    <div class="chalkboard-container">
        <h3>Drag & Dash: Code Your Clean-Up!</h3>
        <p>Drag code blocks to the canvas (or arrow-keys to nudge). Deductive mode: Snap rules to zap spots. Inductive: Hunt patterns to predict fixes! 45-second timer‚Äîdash to run before tick-tock!</p>
        <canvas id="code-canvas" width="600" height="400" style="background: linear-gradient(to bottom, #000428, #004e92); border: 2px solid #8a2be2; border-radius: 10px; cursor: grab;"></canvas>
        <div id="code-timer" style="font-size: 24px; color: #ff6b9d; margin: 10px 0;">Time: 45s ‚è∞ ‚Äì Pick a mode!</div>
        <div class="instruments" style="gap: 15px; justify-content: center;">
            <button class="btn" onclick="startCodeDash('deductive')">üßô Deductive Zap!</button>
            <button class="btn" onclick="startCodeDash('inductive')">üîÆ Inductive Wiggle!</button>
        </div>
        <div id="code-blocks" style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <div class="code-block" draggable="true" data-type="if-smoky" style="background: #ff6b9d; padding: 10px; border-radius: 10px; cursor: grab; font-weight: bold;">If Smoky Puff ‚û°Ô∏è Zap Filter!</div>
            <div class="code-block" draggable="true" data-type="pattern-feather" style="background: #00ff00; padding: 10px; border-radius: 10px; cursor: grab; font-weight: bold;">Spot Feather Pattern ‚û°Ô∏è Predict Flop!</div>
            <div class="code-block" draggable="true" data-type="then-clean" style="background: #8a2be2; padding: 10px; border-radius: 10px; cursor: grab; font-weight: bold;">Then Clean River Giggle!</div>
        </div>
        <div class="controls">
            <button class="btn" onclick="runCodeSpell()">Run the Spell! ‚ú®</button>
            <button class="btn" onclick="resetCodeCave()">Oopsie Reset</button>
        </div>
        <div id="code-message" style="margin-top: 15px; color: #ffff00; font-weight: bold;">Drag a block to start the wiggle!</div>
        <p style="font-size: 14px; color: #00ffff;">üí° Hooty Tip: Snap 3 blocks for full spell‚Äîdeductive zaps direct, inductive predicts the dragon's next puff!</p>
    </div>
    
    <div class="story-text">
        <p>As blocks snapped and spells ran, the cave lit up with clean-web visions: Rivers twinkling, fishies dancing, trees high-fiving birds. "See?" Hooty hooted. "Codes + reason = dragon-defying delight! No hard rules for the wiggly world‚Äîjust smart spells that grow with every giggle."</p>
        
        <div class="character-speech">
            <strong>Little X:</strong> "My spell saved the feather flock! What's next‚Äîcode a star race?"
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="nextBook4Chapter(2)">To Chapter 2: Pattern Party Puzzle!</button>
            <button class="btn" onclick="loadChapter('book3-chapter6')">Back to Book 3 Justice</button>
        </div>
    </div>
</div>

<script>
    // Code Canvas Magic: Drag-Drop + Modes + Timer
    let codeMode = '';
    let codeTimer;
    let timeLeft = 45;
    let draggedBlocks = [];
    let dropZoneActive = false;
    const codeCanvas = document.getElementById('code-canvas');
    const codeCtx = codeCanvas.getContext('2d');
    let blockPositions = []; // For snapped blocks
    
    // Draw mini-web with pollution spots
    function drawCodeWeb() {
        codeCtx.clearRect(0, 0, 600, 400);
        // River background
        codeCtx.fillStyle = '#87CEEB'; codeCtx.fillRect(0, 300, 600, 100);
        // Trees/fish icons
        codeCtx.fillStyle = '#228B22'; codeCtx.fillRect(100, 200, 50, 100); codeCtx.fillText('üå≥', 110, 280);
        codeCtx.fillStyle = '#FF69B4'; codeCtx.beginPath(); codeCtx.arc(400, 350, 15, 0, Math.PI * 2); codeCtx.fill(); codeCtx.fillText('üêü', 395, 355);
        // Pollution spots (if not zapped)
        if (codeMode === 'deductive' && draggedBlocks.length < 2) {
            codeCtx.fillStyle = 'rgba(128, 128, 128, 0.6)'; 
            codeCtx.beginPath(); codeCtx.arc(200, 320, 20, 0, Math.PI * 2); codeCtx.fill(); codeCtx.fillText('üí® Puff', 180, 340);
        } else if (codeMode === 'inductive' && draggedBlocks.length < 2) {
            codeCtx.fillStyle = '#FFD700'; codeCtx.fillText('ü™∂', 300, 250); codeCtx.fillText('ü™∂', 350, 280); // Pattern start
        }
        // Snapped blocks
        blockPositions.forEach((pos, i) => {
            codeCtx.fillStyle = draggedBlocks[i] ? '#00ff00' : '#ff6b9d';
            codeCtx.fillRect(pos.x, pos.y, 80, 30);
            codeCtx.fillStyle = '#000'; codeCtx.font = '12px Arial'; codeCtx.fillText(draggedBlocks[i] || 'Drop Here!', pos.x + 5, pos.y + 20);
        });
    }
    
    // Drag-Drop Setup
    let draggedElement = null;
    document.querySelectorAll('.code-block').forEach(block => {
        block.addEventListener('dragstart', (e) => {
            draggedElement = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.type);
        });
    });
    
    codeCanvas.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneActive = true; });
    codeCanvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const type = e.dataTransfer.getData('text/plain');
        if (draggedBlocks.length < 3) {
            draggedBlocks.push(type);
            blockPositions.push({x: 100 + draggedBlocks.length * 100, y: 100});
            drawCodeWeb();
            document.getElementById('code-message').textContent = `Snapped ${type}! ${draggedBlocks.length === 3 ? 'Full spell‚Äîrun it!' : 'One more block?'}`;
            initAudio(); playTone(523, 0.2, 'piano'); // Snap chime
        }
        dropZoneActive = false;
    });
    
    // Arrow Key Nudge (for accessibility)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' && blockPositions.length > 0) {
            blockPositions[blockPositions.length - 1].x += 10;
            drawCodeWeb();
        } else if (e.key === 'ArrowLeft' && blockPositions.length > 0) {
            blockPositions[blockPositions.length - 1].x -= 10;
            drawCodeWeb();
        }
    });
    
    function startCodeDash(mode) {
        codeMode = mode;
        timeLeft = 45;
        draggedBlocks = [];
        blockPositions = [];
        document.getElementById('code-timer').textContent = `Time: ${timeLeft}s ‚è∞ ‚Äì Drag blocks!`;
        document.getElementById('code-message').textContent = `${mode.toUpperCase()} MODE: ${mode === 'deductive' ? 'Snap rules to zap the puff!' : 'Hunt feather patterns to predict!'}`;
        drawCodeWeb();
        codeTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('code-timer').textContent = `Time: ${timeLeft}s ‚è∞`;
            if (timeLeft <= 10) document.getElementById('code-timer').style.color = '#ff0000'; // Red rush!
            if (timeLeft <= 0) {
                clearInterval(codeTimer);
                document.getElementById('code-message').textContent = 'Tick-tock time-up! Giggle and try again‚Äîcodes love do-overs!';
                initAudio(); playTone(392, 0.3, 'square'); // Oopsie sound
            }
        }, 1000);
        initAudio(); playTone(659, 0.3, 'harp'); // Mode start twirl
    }
    
    function runCodeSpell() {
        if (draggedBlocks.length < 3 || timeLeft <= 0) {
            document.getElementById('code-message').textContent = 'Need 3 blocks and time‚Äîoopsie! Reset for a fresh wiggle?';
            return;
        }
        clearInterval(codeTimer);
        // Animate spell run: Zap or predict
        let animStep = 0;
        const spellAnim = setInterval(() => {
            drawCodeWeb();
            if (codeMode === 'deductive') {
                // Zap animation
                codeCtx.fillStyle = '#00ff00'; codeCtx.beginPath(); codeCtx.arc(200, 320, 20 + animStep * 2, 0, Math.PI * 2); codeCtx.fill(); // Growing green zap
            } else {
                // Pattern complete
                codeCtx.fillStyle = '#FFD700'; codeCtx.fillText('ü™∂ Predict: Flop Here!', 400, 310);
            }
            animStep++;
            if (animStep > 10) {
                clearInterval(spellAnim);
                document.getElementById('code-message').textContent = `Spell success! ${codeMode === 'deductive' ? 'Puff zapped‚Äîriver giggles clean!' : 'Pattern predicted‚Äîfeathers flock safe!'} Web heroes unite with wiggly reason!`;
                initAudio(); 
                playTone(880, 0.5, 'harp'); // Magic boom
                setTimeout(() => {
                    // Sparkle burst
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            const sparkle = document.createElement('div');
                            sparkle.textContent = '‚≠ê';
                            sparkle.style.cssText = `position: absolute; font-size: 20px; color: #ffff00; left: ${Math.random() * 600}px; top: ${Math.random() * 400}px; animation: float-up 1s ease-out forwards; pointer-events: none; z-index: 100;`;
                            codeCanvas.parentElement.appendChild(sparkle);
                            setTimeout(() => sparkle.remove(), 1000);
                        }, i * 100);
                    }
                }, 500);
            }
        }, 200);
    }
    
    function resetCodeCave() {
        clearInterval(codeTimer);
        timeLeft = 45;
        draggedBlocks = [];
        blockPositions = [];
        document.getElementById('code-timer').style.color = '#ff6b9d';
        document.getElementById('code-timer').textContent = 'Time: 45s ‚è∞ ‚Äì Pick a mode!';
        drawCodeWeb();
        document.getElementById('code-message').textContent = 'Cave reset‚Äîfresh blocks await!';
    }
    
    drawCodeWeb(); // Initial draw
</script>
